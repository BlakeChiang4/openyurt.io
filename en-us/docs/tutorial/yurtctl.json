{
  "filename": "yurtctl.md",
  "__html": "<h1><code>Yurtctl</code> tutorial</h1>\n<p>This tutorial demonstrates how to use <code>yurtctl</code> to install/uninstall OpenYurt.\nPlease refer to the <a href=\"https://github.com/openyurtio/openyurt#getting-started\">Getting Started</a> section on the README page to prepare and build binary to <code>_output/bin/yurtctl</code>.\nWe assume a minikube cluster (<a href=\"https://github.com/kubernetes/minikube/releases/tag/v1.0.0\">version 1.14 or less</a>)\nis installed.</p>\n<h2>Convert a minikube cluster</h2>\n<p>Let us use <code>yurtctl</code> to convert a standard Kubernetes cluster to an OpenYurt cluster.</p>\n<ol>\n<li>Run the following command</li>\n</ol>\n<pre><code class=\"language-bash\">$ _output/bin/yurtctl convert --provider minikube\n</code></pre>\n<ol start=\"2\">\n<li><code>yurtctl</code> will install all required components and reset the kubelet in the edge node. The output looks like:</li>\n</ol>\n<pre><code class=\"language-bash\">convert.go:148] mark minikube as the edge-node\nconvert.go:178] deploy the yurt controller manager\nconvert.go:190] deploying the yurt-hub and resetting the kubelet service...\nutil.go:137] servant job(yurtctl-servant-convert-minikube) has succeeded\n</code></pre>\n<ol start=\"3\">\n<li>yurt controller manager and yurthub Pods will be up and running in one minute. Let us verify them:</li>\n</ol>\n<pre><code class=\"language-bash\">$ kubectl get deploy yurt-controller-manager -n kube-system\nNAME            READY   UP-TO-DATE   AVAILABLE   AGE\nyurt-ctrl-mgr   1/1     1            1           23h\n$ kubectl get po yurt-hub-minikube -n kube-system\nNAME                READY   STATUS    RESTARTS   AGE\nyurt-hub-minikube   1/1     Running   0          23h\n</code></pre>\n<ol start=\"4\">\n<li>Next, we mark desired edge nodes as autonomous (only pods running on the autonomous edge nodes will be prevented from being evicted during disconnection):</li>\n</ol>\n<pre><code class=\"language-bash\">$ _output/bin/yurtctl markautonomous\nI0602 14:11:08.610222   89160 markautonomous.go:149] mark minikube-m02 as autonomous\n</code></pre>\n<ol start=\"5\">\n<li>As the minikube cluster only contains one node, the node will be marked as an autonomous edge node. Let us verify this by inspecting the node's labels and annotations:</li>\n</ol>\n<pre><code>$ kubectl describe node | grep Labels -A 5\nLabels:      alibabacloud.com/is-edge-worker=true\n$ kubectl describe node | grep Annotations -A 5\nAnnotations: node.beta.alibabacloud.com/autonomy: true\n</code></pre>\n<p>By now, the OpenYurt cluster is ready. Users will not notice any differences compared to native Kubernetes when operating the cluster.\nIf you login to the node, you will find the local cache has been populated:</p>\n<pre><code>$ minikube ssh\n$ ls /etc/kubernetes/cache/kubelet/\nconfigmaps  events  leases  nodes  pods  secrets  services\n</code></pre>\n<h3>Test node autonomy</h3>\n<p>To test if edge node autonomy works as expected, we will simulate a node &quot;offline&quot; scenario.</p>\n<pre><code class=\"language-bash\">kubectl apply -f-&lt;&lt;EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: bbox\nspec:\n  containers:\n  - image: busybox\n    <span class=\"hljs-built_in\">command</span>:\n    - top\n    name: bbox\nEOF\n</code></pre>\n<ol start=\"2\">\n<li>Make the edge node &quot;offline&quot; by changing the <code>yurthub</code>'s server-addr to an unreachable address:</li>\n</ol>\n<pre><code class=\"language-bash\">$ minikube ssh\n$ sudo sed -i <span class=\"hljs-string\">'s|--server-addr=.*|--server-addr=https://1.1.1.1:1111|'</span> /etc/kubernetes/manifests/yurt-hub.yaml\n</code></pre>\n<ol start=\"3\">\n<li>Now <code>yurthub</code> is disconnected from the apiserver and works in offline mode. To verify this, we can do the following:</li>\n</ol>\n<pre><code class=\"language-bash\">$ minikube ssh\n$ curl -s &lt;http://127.0.0.1:10261&gt;\n{\n  <span class=\"hljs-string\">\"kind\"</span>: <span class=\"hljs-string\">\"Status\"</span>,\n  <span class=\"hljs-string\">\"metadata\"</span>: {\n\n  },\n  <span class=\"hljs-string\">\"status\"</span>: <span class=\"hljs-string\">\"Failure\"</span>,\n  <span class=\"hljs-string\">\"message\"</span>: <span class=\"hljs-string\">\"request( get : /) is not supported when cluster is unhealthy\"</span>,\n  <span class=\"hljs-string\">\"reason\"</span>: <span class=\"hljs-string\">\"BadRequest\"</span>,\n  <span class=\"hljs-string\">\"code\"</span>: 400\n}\n</code></pre>\n<ol start=\"4\">\n<li>After 40 seconds, the edge node status becomes <code>NotReady</code>, but the pod/bbox won't be evicted and keeps running on the node:</li>\n</ol>\n<pre><code class=\"language-bash\">$ kubectl get node &amp;&amp; kubectl get po\nNAME       STATUS     ROLES    AGE   VERSION\nminikube   NotReady   master   58m   v1.18.2\nNAME   READY   STATUS    RESTARTS   AGE\nbbox   1/1     Running   0          19m\n</code></pre>\n<h2>Convert a multi-nodes Kubernetes cluster</h2>\n<p>An OpenYurt cluster may consist of some edge nodes and some nodes in the cloud site.\n<code>yurtctl</code> allows users to specify a list of cloud nodes that won't be converted.</p>\n<ol>\n<li>Start with a <a href=\"https://cn.aliyun.com/product/kubernetes\">two-nodes ack cluster</a>,</li>\n</ol>\n<pre><code class=\"language-bash\">$ kubectl get node\nNAME                     STATUS   ROLES    AGE   VERSION\nus-west-1.192.168.0.87   Ready    &lt;none&gt;   19h   v1.14.8-aliyun.1\nus-west-1.192.168.0.88   Ready    &lt;none&gt;   19h   v1.14.8-aliyun.1\n</code></pre>\n<ol start=\"2\">\n<li>You can convert only one node to edge node(i.e., minikube-m02) by using this command:</li>\n</ol>\n<pre><code class=\"language-bash\">$ _output/bin/yurtctl convert --provider ack --cloud-nodes us-west-1.192.168.0.87\nI0529 11:21:05.835781    9231 convert.go:145] mark us-west-1.192.168.0.87 as the cloud-node\nI0529 11:21:05.861064    9231 convert.go:153] mark us-west-1.192.168.0.88 as the edge-node\nI0529 11:21:05.951483    9231 convert.go:183] deploy the yurt controller manager\nI0529 11:21:05.974443    9231 convert.go:195] deploying the yurt-hub and resetting the kubelet service...\nI0529 11:21:26.075075    9231 util.go:147] servant job(yurtctl-servant-convert-us-west-1.192.168.0.88) has succeeded\n</code></pre>\n<ol start=\"3\">\n<li>Node <code>us-west-1.192.168.0.87</code> will be marked as a non-edge node. You can verify this by inspecting its labels:</li>\n</ol>\n<pre><code class=\"language-bash\">$ kubectl describe node us-west-1.192.168.0.87 | grep Labels\nLabels:             openyurt.io/is-edge-worker=<span class=\"hljs-literal\">false</span>\n</code></pre>\n<ol start=\"4\">\n<li>Same as before, we make desired edge nodes autonomous:</li>\n</ol>\n<pre><code class=\"language-bash\">$ _output/bin/yurtctl markautonomous\nI0602 11:22:05.610222   89160 markautonomous.go:149] mark us-west-1.192.168.0.88 as autonomous\n</code></pre>\n<ol start=\"5\">\n<li>When the OpenYurt cluster contains cloud nodes, yurt controller manager will be deployed on the cloud node (in this case, the node <code>us-west-1.192.168.0.87</code>):</li>\n</ol>\n<pre><code class=\"language-bash\">$ kubectl get pods -A -o=custom-columns=<span class=\"hljs-string\">'NAME:.metadata.name,NODE:.spec.nodeName'</span>\nNAME                                               NODE\nyurt-controller-manager-6947f6f748-lxfdx           us-west-1.192.168.0.87\n</code></pre>\n<h2>Setup Yurttunnel</h2>\n<p>Since version v0.2.0, users can setup the yurttunnel using <code>yurtctl convert</code>.</p>\n<p>Assume that the origin cluster is a two-nodes minikube cluster:</p>\n<pre><code class=\"language-bash\">$ kubectl get node -o wide\nNAME           STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION     CONTAINER-RUNTIME\nminikube       Ready    master   72m   v1.18.3   172.17.0.3    &lt;none&gt;        Ubuntu 20.04 LTS   4.19.76-linuxkit   docker://19.3.8\nminikube-m02   Ready    &lt;none&gt;   71m   v1.18.3   172.17.0.4    &lt;none&gt;        Ubuntu 20.04 LTS   4.19.76-linuxkit   docker://19.3.8\n</code></pre>\n<p>Then, by simply running the <code>yurtctl convert</code> command with the enabling of the option <code>--deploy-yurttunnel</code>,\nyurttunnel servers will be deployed on cloud nodes, and an yurttunnel agent will be deployed on every edge node.</p>\n<pre><code class=\"language-bash\">$ yurtctl convert --deploy-yurttunnel --cloud-nodes minikube --provider minikube\nI0831 12:35:51.719391   77322 convert.go:214] mark minikube as the cloud-node\nI0831 12:35:51.728246   77322 convert.go:222] mark minikube-m02 as the edge-node\nI0831 12:35:51.753830   77322 convert.go:251] the yurt-controller-manager is deployed\nI0831 12:35:51.910440   77322 convert.go:270] yurt-tunnel-server is deployed\nI0831 12:35:51.999384   77322 convert.go:278] yurt-tunnel-agent is deployed\nI0831 12:35:51.999409   77322 convert.go:282] deploying the yurt-hub and resetting the kubelet service...\nI0831 12:36:22.109338   77322 util.go:173] servant job(yurtctl-servant-convert-minikube-m02) has succeeded\nI0831 12:36:22.109368   77322 convert.go:292] the yurt-hub is deployed\n</code></pre>\n<p>To verify that the yurttunnel works as expected, please refer to\nthe <a href=\"https://github.com/openyurtio/openyurt/blob/master/docs/tutorial/yurt-tunnel.md\">yurttunnel tutorial</a></p>\n<h2>Set the path of configuration</h2>\n<p>Sometimes the configuration of the node may be different. Users can set the path of the kubelet service configuration\nby the option <code>--kubeadm-conf-path</code>, which is used by kubelet component to join the cluster on the edge node.</p>\n<pre><code>$ _output/bin/yurtctl convert --kubeadm-conf-path /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n</code></pre>\n<p>The path of the directory on edge node containing static pod files can be set by the\noption <code>--pod-manifest-path</code>.</p>\n<pre><code>$ _output/bin/yurtctl convert --pod-manifest-path /etc/kubernetes/manifests\n</code></pre>\n<h2>Revert/Uninstall OpenYurt</h2>\n<p>Using <code>yurtctl</code> to revert an OpenYurt cluster can be done by doing the following:</p>\n<pre><code>$ _output/bin/yurtctl revert\nrevert.go:100] label alibabacloud.com/is-edge-worker is removed\nrevert.go:110] yurt controller manager is removed\nrevert.go:124] ServiceAccount node-controller is created\nutil.go:137] servant job(yurtctl-servant-revert-minikube-m02) has succeeded\nrevert.go:133] yurt-hub is removed, kubelet service is reset\n</code></pre>\n<p>Note that before performing the uninstall, please make sure all edge nodes are reachable from the apiserver.</p>\n<p>In addition, the path of the kubelet service configuration can be set by the option <code>--kubeadm-conf-path</code>,\nand the path of the directory on edge node containing static pod files can be set by the option <code>--pod-manifest-path</code>.</p>\n<h2>Subcommand</h2>\n<h3>Convert a Kubernetes node to Yurt edge node</h3>\n<p>You can use the subcommand <code>yurtctl convert edgenode</code> to convert a Kubernetes node to Yurt edge node separately.</p>\n<p>This command can convert the node locally or remotely. One or more nodes that need to be converted can be specified\nby the option <code>--edge-nodes</code>. If this option is not used, the local node will be converted.</p>\n<p>Convert the Kubernetes node n80 to an Yurt edge node:</p>\n<pre><code>$ _output/bin/yurtctl convert edgenode --edge-nodes n80\nI0209 11:03:30.101308   13729 edgenode.go:251] mark n80 as the edge-node\nI0209 11:03:30.136313   13729 edgenode.go:279] setting up yurthub on node\nI0209 11:03:30.137013   13729 edgenode.go:294] setting up yurthub apiserver addr\nI0209 11:03:30.137500   13729 edgenode.go:311] create the /etc/kubernetes/manifests/yurt-hub.yaml\nI0209 11:03:40.140073   13729 edgenode.go:403] yurt-hub healthz is OK\nI0209 11:03:40.140555   13729 edgenode.go:330] revised kubeconfig /var/lib/openyurt/kubelet.conf is generated\nI0209 11:03:40.141592   13729 edgenode.go:351] kubelet.service drop-in file is revised\nI0209 11:03:40.141634   13729 edgenode.go:354] systemctl daemon-reload\nI0209 11:03:40.403453   13729 edgenode.go:359] systemctl restart kubelet\nI0209 11:03:40.469911   13729 edgenode.go:364] kubelet has been restarted\n</code></pre>\n<p>You can verify this by inspecting its labels and getting the status of pod yurt-hub.</p>\n<h3>Revert an Yurt edge node to Kubernetes node</h3>\n<p>The subcommand <code>yurtctl revert edgenode</code> can revert a Yurt edge node. The option <code>--edge-nodes</code> of command can be used\nto specify one or more nodes to be reverted which is the same as the <code>yurtctl convert edgenode</code>.</p>\n<p>Assume that the cluster is an OpenYurt cluster and has an Yurt edge node n80:</p>\n<pre><code>$ kubectl describe node n80 | grep Labels\nLabels:             openyurt.io/is-edge-worker=true\n$ kubectl get pod -A | grep yurt-hub\nkube-system   yurt-hub-n80               1/1     Running   0          7m32s\n</code></pre>\n<p>Using <code>yurtctl revert edgenode</code> to revert:</p>\n<pre><code>$ _output/bin/yurtctl revert edgenode --edge-nodes n80\nI0209 11:01:46.837812   12217 edgenode.go:225] label alibabacloud.com/is-edge-worker is removed\nI0209 11:01:46.838454   12217 edgenode.go:252] found backup file /etc/systemd/system/kubelet.service.d/10-kubeadm.conf.bk, will use it to revert the node\nI0209 11:01:46.838689   12217 edgenode.go:259] systemctl daemon-reload\nI0209 11:01:47.085554   12217 edgenode.go:265] systemctl restart kubelet\nI0209 11:01:47.153388   12217 edgenode.go:270] kubelet has been reset back to default\nI0209 11:01:47.153680   12217 edgenode.go:282] yurt-hub has been removed\n</code></pre>\n<p>You can verify this by inspecting its labels and getting the status of pod yurt-hub.</p>\n<h2>Troubleshooting</h2>\n<h3>1. Failure due to pulling image timeout</h3>\n<p>The default timeout value of cluster conversion is 2 minutes. Sometimes pulling the related images\nmight take more than 2 minutes. To avoid the conversion failure due to pulling images timeout, you can:</p>\n<ul>\n<li>use mirrored image from aliyun container registry(ACR)</li>\n</ul>\n<pre><code class=\"language-bash\">$ _output/bin/yurtctl convert --provider minikube \\\n  --yurt-controller-manager-image registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-controller-manager:latest \\\n  --yurt-tunnel-agent-image registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-agent:latest \\\n  --yurt-tunnel-server-image registry.cn-hangzhou.aliyuncs.com/openyurt/yurt-tunnel-server:latest \\\n  --yurtctl-servant-image registry.cn-hangzhou.aliyuncs.com/openyurt/yurtctl-servant:latest \\\n  --yurthub-image registry.cn-hangzhou.aliyuncs.com/openyurt/yurthub:latest\n</code></pre>\n<ul>\n<li>or pull all images on the node manually\nor use automation tools such as <code>broadcastjob</code>(from <a href=\"https://github.com/openkruise/kruise/blob/master/docs/tutorial/broadcastjob.md\">Kruise</a>) in advance.</li>\n</ul>\n<h3>2. Adhoc failure recovery</h3>\n<p>In case any adhoc failure makes the Kubelet fail to communicate with APIServer, one can recover the original Kubelet setup by\nrunning the following command in edge node directly:</p>\n<pre><code>$ sudo sed -i &quot;s|--kubeconfig=.*kubelet.conf|--kubeconfig=/etc/kubernetes/kubelet.conf|g;&quot; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &amp;&amp; sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart kubelet.service\n</code></pre>\n",
  "link": "/en-us/docs/tutorial/yurtctl.html",
  "meta": {}
}