{
  "filename": "yurt-tunnel.md",
  "__html": "<h1>Yurt-tunnel tutorial</h1>\n<h2>Use Yurt-tunnel to connect apiserver and edge node</h2>\n<p>In this tutorial, we will show how the yurt-tunnel helps the apiserver send\nrequest to nodes when the network traffic from apiserver to the node is\nblocked. To mimic the real scenario where the cloud node and edge nodes may\nlocate in separate network regions, we use a two-nodes minikube as the\nexperimental cluster.</p>\n<h3>1. Provision a minikube cluster</h3>\n<p>Start from version 1.10, minikube allows users to provision multinode clusters.\nDepending on the version you are using, minikube may use docker as the default\ndriver, which is not supported by yurt-tunnel. Therefore, make sure to choose\nhyperkit or virtualbox as your driver. For example, the OSX user can create a\ntwo-nodes minikube cluster by typing the following command:</p>\n<pre><code class=\"language-bash\">minikube start --nodes 2 --driver hyperkit\n</code></pre>\n<p>If everything goes right, we will have a two-nodes cluster up and running:</p>\n<pre><code class=\"language-bash\">$ kubectl get nodes -o wide\nNAME           STATUS   ROLES    AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE               KERNEL-VERSION   CONTAINER-RUNTIME\nminikube       Ready    master   3h50m   v1.18.3   192.168.64.3   &lt;none&gt;        Buildroot 2019.02.11   4.19.114         docker://19.3.12\nminikube-m02   Ready    &lt;none&gt;   3h48m   v1.18.3   192.168.64.9   &lt;none&gt;        Buildroot 2019.02.11   4.19.114         docker://19.3.12\n</code></pre>\n<p>In the rest of this tutorial, we will assume that the node named <code>minikube</code> is the\ncloud node, and the node named <code>minikube-m02</code> is the edge node.</p>\n<h3>2. Create a test pod</h3>\n<p>As we plan to test the functionality of routing requests from the apiserver to\nnodes, which usually happens when the apiserver receives requests of accessing\nthe pods, let's create a test pod that will run on the edge node.</p>\n<pre><code class=\"language-bash\">$ kubectl apply -f-&lt;&lt;EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: <span class=\"hljs-built_in\">test</span>-po\n  namespace: default\nspec:\n  nodeName: minikube-m02\n  containers:\n  - name: <span class=\"hljs-built_in\">test</span>-po\n    image: busybox\n    <span class=\"hljs-built_in\">command</span>:\n    - top\nEOF\n</code></pre>\n<p>After the <code>test-po</code> is running, we can check the connection between the apiserver\nand the node by typing the following commands:</p>\n<pre><code class=\"language-bash\">$ kubectl <span class=\"hljs-built_in\">exec</span> <span class=\"hljs-built_in\">test</span>-po -- date\nFri Aug  7 23:17:27 UTC 2020\n</code></pre>\n<h3>4. Block the network traffic from the apiserver to the node</h3>\n<p>Next, let's block the network traffic from the apiserver to the node by dropping\nnetwork packages that are sent from the apiserver to the node. Specifically,\nwe add a nat rule to the cloud node that drops all packets to the node with\ndestination port set as 10250 (kubelet listens on port 10250 which receives\nhttps request from the apiserver).</p>\n<pre><code class=\"language-bash\">$ minikube ssh\n                         _             _\n            _         _ ( )           ( )\n  ___ ___  (_)  ___  (_)| |/<span class=\"hljs-string\">')  _   _ | |_      __\n/'</span> _ ` _ `\\| |/<span class=\"hljs-string\">' _ `\\| || , &lt;  ( ) ( )| '</span>_`\\  /<span class=\"hljs-string\">'__`\\\n| ( ) ( ) || || ( ) || || |\\`\\ | (_) || |_) )(  ___/\n(_) (_) (_)(_)(_) (_)(_)(_) (_)`\\___/'</span>(_,__/<span class=\"hljs-string\">'`\\____)\n\n$ sudo iptables -A OUTPUT -p tcp -d 192.168.64.9 --dport 10250 -j DROP\n</span></code></pre>\n<p>Now, if we try to execute the <code>date</code> command in <code>test-po</code> again, the command\nwill hang.</p>\n<h3>5. Setup the yurt-tunnel manually</h3>\n<p>It is recommended to use <code>yurtctl</code> tool to deploy yurt-tunnel components by\nadding the <code>--deploy-yurttunnel</code> option when coverting a Kubernetes cluster. For example,</p>\n<pre><code class=\"language-bash\">yurtctl convert --cloud-nodes minikube --provider minikube --deploy-yurttunnel\n</code></pre>\n<p>You may also setup the yurt-tunnel manually by deploying yurt-tunnel-server\nand yurt-tunnel-agent separately.</p>\n<p>To set up the yurt-tunnel-server, let's first add a label to the cloud node</p>\n<pre><code class=\"language-bash\">kubectl label nodes minikube openyurt.io/is-edge-worker=<span class=\"hljs-literal\">false</span>\n</code></pre>\n<p>Then, we can deploy the yurt-tunnel-server:</p>\n<pre><code class=\"language-bash\">$ kubectl apply -f config/setup/yurt-tunnel-server.yaml\n</code></pre>\n<p>Next, we can set up the yurt-tunnel-agent. Like before, we add a label to the\nedge node, which allows the yurt-tunnel-agent to be run on the edge node:</p>\n<pre><code class=\"language-bash\">kubectl label nodes minikube-m02 openyurt.io/edge-enable-reverseTunnel-client=<span class=\"hljs-literal\">true</span>\n</code></pre>\n<p>And, apply the yurt-tunnel-agent yaml:</p>\n<pre><code class=\"language-bash\">kubectl apply -f config/setup/yurt-tunnel-agent.yaml\n</code></pre>\n<p>After the agent and the server are running, we should execute the command in\nthe test-po again.</p>\n",
  "link": "/zh-cn/docs/tutorial/yurt-tunnel.html",
  "meta": {}
}